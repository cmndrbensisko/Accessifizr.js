define(["dojo/_base/declare","dojo/_base/lang","dojo/topic","dojo/dom","dojo/query","dojo/dom-attr","dojo/dom-construct","dojo/json","dojo/on","dojo/keys","dojo/_base/array","dojo/dom-class","dojo/Deferred","dijit/focus","dojo/i18n!./nls/strings","dojo/domReady!"],function(e,t,o,r,s,a,d,c,l,f,u,h,p,b,v){function y(e,t){var n=new p,i=setInterval(dojo.hitch(this,function(){(s(e.id).length>0&&!t||s(e.id).length>0&&"none"!=s(e.id)[0].style.display&&t)&&(n.resolve(e),clearInterval(i))},100));return n.promise}function m(e,n){if(t.exists(n,e)){var i=e[n].replace(/\[.*\]/g,"");return i}return null}function g(e,n,i){var o=!1;if(t.exists(i,n)){var r=n[i].split(",");r.forEach(function(t){/\[/g.test(t)?e.type==t.replace(/\[.*\]/g,"")&&u.indexOf(t.match(/\[(.*?)\]/)[1].split("|"),e.keyCode)>=0&&(o=!0):t==e.type&&(o=!0)})}else o=!1;return o}function x(e){t.exists("preserveTabs",e)?e.preserveTabs||k():k(),t.exists("escModes",e)&&u.forEach(e.objects,function(t){t.escModes=e.escModes,t.onEsc=e.onEsc}),u.forEach(e.objects,function(e){var n=y(e,!1);n.then(dojo.hitch(this,function(e){s(e.id).forEach(function(n){if(v[e.id]&&a.set(n,"alt",v[e.id]),t.exists("gridConfig",e)?"dgrid"==e.gridConfig.type&&s("[tabindex=0]",s(e.id)[0]).forEach(function(t){_(t,e.tab)}):_(n,e.tab),t.exists("onClick",e)){var i=[];t.exists("objects",e.onClick)&&i.push(function(){x(e.onClick)}),t.exists("back",e.onClick)&&i.push(function(){x(B(E(parseData,"id",e.id)[0],e.onClick.back))}),handlerBus.push(l(n,m(e,"clickModes"),t.hitch(this,function(n){if(g(n,e,"clickModes")){if(t.exists("clickControl",e))var o=s(e.clickControl)[0];else var o=b.curNode;if(t.exists("clickControlEvt",e))var r=e.clickControlEvt;else var r="click";if(n.type!==r)l.emit(o,r,{bubbles:!0});else if(i.forEach(function(e){e()}),t.exists("onClick.focus",e)){var a=y(e.onClick.focus,!0);a.then(dojo.hitch(this,function(e){s(e.id)[0].focus()}))}}})))}t.exists("onEsc",e)&&handlerBus.push(l(n,m(e,"escModes"),function(t){if(g(t,e,"escModes")){var n=e.onEsc.escControl;n="self"==n?b.curNode:s(n)[0],t.type!==e.onEsc.escControlEvt&&l.emit(n,e.onEsc.escControlEvt,{bubbles:!0})}}))})}))})}function j(e){return"IMG"==e.nodeName&&!h.contains(e,"layerTile")&&!h.contains(e,"canBeHidden")&&!h.contains(e,"alwaysHidden")}function k(){for(i=0;10>=i;i++)s('[tabIndex="'+i+'"]',document.body).forEach(function(e){_(e,-1)});u.forEach(handlerBus,function(e){e.remove()})}function C(e){for(;e.parentNode;)return e=e.parentNode;return null}function E(e,t,n){var i=[];for(var o in e)e.hasOwnProperty(o)&&"parent"!=o&&("object"==typeof e[o]?i=i.concat(E(e[o],t,n)):o==t&&e[o]==n||o==t&&""==n?i.push(e):e[o]==n&&""==t&&-1==i.lastIndexOf(e)&&i.push(e));return i}function N(e,t){var n={div:function(e){var t=T("div",e);t.style.background="transparent url("+e.src+") no-repeat",t.attributes.originalDiv=e.outerHTML;var n=new Image;n.src=e.src,(n.width>e.width||n.height>e.height)&&(t.style.backgroundSize=e.width+"px "+e.height+"px",t.style["-webkit-background-size"]=e.width+"px "+e.height+"px"),t.style.display="inline-block",e.style.display="none",e.style.visibility="hidden",a.set(e,"aria-hidden","true"),l(t,"click",function(){l.emit(e,"click",{})}),l(t,"keydown",function(){l.emit(e,"keydown",{})}),""==e.id&&(e.id=M()),t.id=e.id+"_dis",0==s("#"+e.id+"_dis").length&&d.place(t,e,"after")},img:function(e){e.style.display="inline-block",e.style.visibility="",a.set(e,"aria-hidden","false"),""!=e.id&&s("#"+e.id+"_dis").length>0&&d.destroy(s("#"+e.id+"_dis")[0])}};return n[e](t)}function w(e){var t=new p;return setTimeout(function(){""!=e.src&&t.resolve(e)},100),t.promise}function M(){for(var e="",t="abcdefghijklmnopqrstuvwxyz0123456789",n=0;10>n;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}function T(e,t){var n,i,o=document.createElement(e),r=t.attributes,s=r.length;for(t=t.cloneNode(!0);t.firstChild;)o.appendChild(t.firstChild);for(n in t)try{i=t[n],!i||"outerHTML"===n||"string"!=typeof i&&"number"!=typeof i||(o[n]=t[n])}catch(a){}for(n=0;s>n;n++)o.setAttribute(r[n].nodeName,r[n].value);return o.style.cssText=t.style.cssText,o}function B(e,t){for(i=0;t>=i;i++)e=e.parent;return e}function I(e,t){if(e.parent=t,"undefined"!=typeof e)for(n in e.objects)e.objects[n].parent=e,e.objects[n].onClick&&I(e.objects[n].onClick,e)}function _(e,t){a.set(e,"tabIndex",t),options.applyAria&&H(e)}function D(e,t){w(t).then(function(t){N(e,t)})}function H(e){if(-1==u.indexOf(options.exemptTags,e.nodeName)){if(0==a.get(e,"tabindex")||a.get(e,"tabindex")>0){a.set(e,"aria-hidden","false"),j(e)&&D("img",e),a.remove(e,"role");for(var t=e;null!==C(t);)a.set(t,"aria-hidden","false"),a.remove(t,"role"),t=C(t);dojo.query("*",e).forEach(function(e){h.contains(e,"alwaysHidden")||a.set(e,"aria-hidden","false"),j(e)&&D("img",e)})}-1==a.get(e,"tabindex")&&(a.set(e,"aria-hidden","true"),j(e)&&D("div",e),a.set(e,"role","presentation"),null!=e.parentNode&&"H2"==e.parentNode.nodeName&&(a.set(e.parentNode,"aria-hidden","true"),j(e.parentNode)&&D("div",e.parentNode),a.set(e.parentNode,"role","presentation")),dojo.query("*",e).forEach(function(t){if(0==a.get(t,"tabindex")||a.get(t,"tabindex")>0){a.set(e,"aria-hidden","false"),j(e)&&D("img",e),a.remove(e,"role"),a.set(t,"aria-hidden","false"),j(t)&&D("img",t),a.remove(t,"role");for(var n=e;null!==C(n);)a.set(n,"aria-hidden","false"),j(n)&&D("img",n),a.remove(n,"role"),n=C(n)}j(t)&&D("div",t)}))}}return{init:function(e){options={exemptTags:["B","BR"],exemptClasses:["layerTile"],applyAria:!1},t.mixin(options,e),handlerBus=[],parseData=c.parse(options.data),I(parseData.tabOrder,null),s("*",document.body).forEach(function(e){_(e,-1)}),x(parseData.tabOrder)}}});